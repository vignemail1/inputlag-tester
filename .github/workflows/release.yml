name: Build and Release (Windows)

on:
  push:
    tags:
    - "v*.*.*" # d√©clenche sur tag vX.Y.Z (ex: v1.0.0)

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout sources
      uses: actions/checkout@v4

    - name: Set up MSVC dev environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: amd64

    - name: Build inputlag-tester.exe
      shell: pwsh
      run: |
        cl /std:c++17 /W4 /O2 /EHsc inputlag-tester.cpp `
          /link dxgi.lib d3d11.lib kernel32.lib user32.lib `
          /OUT:inputlag-tester.exe

    - name: Archive binary
      shell: pwsh
      run: |
        mkdir dist
        copy inputlag-tester.exe dist/
        compress-archive -Path dist\* -DestinationPath inputlag-tester-windows-amd64.zip

    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: inputlag-tester ${{ github.ref_name }}
        draft: false
        prerelease: false
        files: |
          inputlag-tester-windows-amd64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
